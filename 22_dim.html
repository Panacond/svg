<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap");

      .text {
        text-anchor: middle;
        font-size: 0.3em;
        /* font-family:Arial, Helvetica, sans-serif; */
        /* font-family: 'Arial Condensed', Arial, sans-serif; */
        font-family: "Oswald", "GOST Type B", "Arial", sans-serif;
        letter-spacing: 0;
      }

      .dim {
        fill: none;
        stroke: red;
        stroke-width: 0.1mm;
      }

      .line {
        fill: none;
        stroke: black;
        stroke-width: 0.2mm;
      }

      .scale1-2 {
        transform: scale(0.5);
      }

      .scale1-2 .line,
      .scale1-2 .hatch,
      .scale1-2 .hatch2 {
        stroke-width: calc(0.2mm * 2);
        /* stroke: red;  */
      }

      .scale1-2 .dim,
      .scale1-2 .axe,
      .scale1-2 .hidden {
        stroke-width: calc(0.1mm * 2);
        /* stroke: red;  */
      }
      .scale1-2 text {
        /* stroke-width: calc(0.2mm * 2); */
        transform: scale(1);
        fill: red;
        font-size: calc(0.3em * 2);
      }
    </style>
  </head>
  <body>
    <svg id="draw" width="210mm" height="200mm" viewBox="0 0 210 200">
      <text x="50" y="10" class="text">Деталь П1</text>
      <rect class="line" x="20" y="20" width="100" height="50" />

      <path class="dim" d="M20 20 v50 h-15" />
      <path class="dim" d="M20 70 h100 v15" />

      <g class="scale1-2">
        <g class="plan">
          <g id="plan" transform="translate(100, 200)">
            <text x="50" y="-10" class="text">Деталь П1</text>
            <rect class="line" x="0" y="0" width="200" height="100" />

            <path class="dim" d="M0 0 v100 h-15" />
            <path class="dim" d="M0 100 h200 v15" />
          </g>
        </g>
      </g>
    </svg>
    <p id="output">вывод:</p>
    <script>
      function output(a) {
        document.getElementById("output").innerHTML += "<br>" + a;
      }

      function parseDim(pathData) {
        // const pathData = "M20 20 v50 h-15";
        const result = {};
        const commands = [];

        const moveCommandRegex = /^M([\d\.\-]+)\s+([\d\.\-]+)/i;
        const lineCommandRegex = /([vhl])([\d\.\-]+)/gi;

        const moveMatch = pathData.match(moveCommandRegex);
        if (moveMatch) {
          result.x = parseFloat(moveMatch[1]);
          result.y = parseFloat(moveMatch[2]);
        }

        let match;
        while ((match = lineCommandRegex.exec(pathData)) !== null) {
          const type = match[1].toLowerCase();
          const length = parseFloat(match[2]);
          let indent = 0;
          if (type === "h" && length < 0) {
            indent = length;
          } else if (type === "v" && length < 0) {
            indent = length;
          }

          commands.push({
            type: type,
            length: Math.abs(length),
          });
        }
        data = { x: result.x, y: result.y, c: commands };
        return data;
      }

      function replaceSquaresWithColoredTriangles() {
        const svgContainer = document.getElementsByTagName("svg")[0];

        const dimentions = document.querySelectorAll(".dim");

        dimentions.forEach((dim) => {
          const parentElement = dim.parentNode;
          const scale= processElement(dim)

          const d = dim.getAttribute("d");
          output(d);
          console.log(d);

          const data = parseDim(d);
          const angle = data.c[0].type === "v" ? 90 : 0;
          const triangleHTML = `<g transform="rotate(${angle},${data.x},${
            data.y
          } )">
          <path d="M ${data.x} ${data.y} v${data.c[1].length + 2} v-2 h${
            data.c[0].length
          } v2 v${-data.c[1].length - 2}" class="dim"/>
          <path class="anno" d="M ${data.x} ${
            data.y + data.c[1].length
          } l4 1 v-2 z" fill="red" transform="scale(${scale})"
           transform-origin="${data.x} ${data.y + data.c[1].length}"/>
          <path class="anno" d="M ${data.x + data.c[0].length} ${
            data.y + data.c[1].length
          } l-4 1 v-2 z" fill="red" transform="scale(${scale})"
           transform-origin="${data.x + data.c[0].length} ${data.y + data.c[1].length}" ;/>/>
          <text class="text" id="dynamicText" x="${
            data.x + data.c[0].length / 2
          }" y="${data.y + data.c[1].length - 2*scale}">${
            data.c[0].length
          }</text></g>`;

          // // Додаємо новий трикутник перед видаленням квадрата (для збереження порядку, якщо це важливо)
          parentElement.insertAdjacentHTML("beforeend", triangleHTML);
          dim.remove();
        });
      }

      document.addEventListener(
        "DOMContentLoaded",
        replaceSquaresWithColoredTriangles
      );

      

      function processElement(element) {
        let currentElement = element.parentNode;
        const parentClasses = [];

        while (currentElement) {
          if (currentElement.classList && currentElement.classList.length > 0) {
            parentClasses.push(...currentElement.classList);
          }
          currentElement = currentElement.parentNode;
        }

        const regex = /(scale)(\d+)-(\d+)/;
        const match = parentClasses.join(", ").match(regex);
        let scale;

        if (match) {
          const scaleFull = match[0];
          const scaleStart = match[2];
          const scaleEnd = match[3];
          scale = match[3] / match[2];

          console.log("Полное совпадение:", scaleFull);
          console.log("scale:", scale);
        } else {
          console.log("Совпадений не найдено.");
          scale = 1;
        }
        return scale;
      }
    </script>
    
    <script>
      const dimElements = document.querySelectorAll(".dim");

dimElements.forEach((element) => {
  let currentElement = element.parentNode;
  const parentClasses = [];
  while (currentElement) {
    if (currentElement.classList && currentElement.classList.length > 0) {
      parentClasses.push(...currentElement.classList);
    }
    currentElement = currentElement.parentNode;
  }
  const regex = /(scale)(\d+)-(\d+)/;
  const match = parentClasses.join(", ").match(regex);

  if (match) {
    const scaleFull = match[0];
    const scaleStart = match[2];
    const scaleEnd = match[3];
    const scale = match[3] / match[2];

    console.log("Полное совпадение:", scaleFull); // Выведет: scale1-2
    console.log("Начальное число:", scaleStart); // Выведет: 1
    console.log("Конечное число:", scaleEnd); // Выведет: 2
    console.log("scale:", scale); // Выведет: 2
  } else {
    console.log("Совпадений не найдено.");
    const scale = 1;
  }
  console.log(
    `Классы всех родительских элементов: ${parentClasses.join(", ")}`
  );
  output(
    `Классы всех родительских элементов: ${parentClasses.join(", ")}`
  );
});
    </script>
  </body>
</html>
